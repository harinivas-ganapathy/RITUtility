<!DOCTYPE html>
<html>
  <head>
    <title>XML TAG UPDATE FOR RIT</title>
  </head>
  <body>
    <P>Enter a Raw XML</p>
    <textarea id="RawXMLTXTA" rows="20" cols="75"></textarea><br>
    <button type="button" onclick="updateXML();"><B>Process XML</B></button>
    <button type="button" onclick="clearTxt();"><B>Clear</B></button>
    <button type="button" onclick="refresh();"><B>Refresh</B></button><br>
    <p>Updated XML for RIT</p>
    <textarea id="UpdatedXMLTXTA" rows="20" cols="75"></textarea><br>
    <script type="text/javascript">
    var hTable = {};
    var xmlSer = new XMLSerializer();
    var sURL = unescape(window.location.pathname); //storing the URL for refreshing the page
      function updateXML(){
        hTable = {};
        document.getElementById("UpdatedXMLTXTA").value = null;
        console.log("Hello World! Function Successfully Called");
        //---this is for IE.
        var strForXML = document.getElementById("RawXMLTXTA").value;
        var RawXML = null;
        var txt="";
        console.log(strForXML);
        if(window.ActiveXObject){
          RawXML = new ActiveXObject("Microsoft.XMLDOM");
          RawXML.async="false";
          RawXML.load(strForXML);
        }else if(document.implementation && document.implementation.createDocument){
          try{//--- this is for FF, opera and others.
            RawXML = document.implementation.createDocument("","",null);
            RawXML.load(strForXML);
          }
          catch(e){// if the other one fails enters here for Safari
          RawXML = new DOMParser().parseFromString(strForXML, "text/xml");
          RawXML.normalize();
          console.log(new XMLSerializer().serializeToString(RawXML));
          }
        }
          x = RawXML.getElementsByTagName("*");
          console.log("x length: " + x.length);

          for (i = 0; i < x.length ;i++) {
            //console.log(x[i].firstChild.nodeType);
            // Check for is a text node and containing element has no child
            //if ( (x[i].firstChild.nodeType == 3 || x[i].firstChild.nodeType == 4) && x[i].firstChild.isEqualNode(x[i].lastChild))
            //&& (x[i].firstChild.nodeType == 3 && x[i].lastChild.nodeType == 3)
            var xchildNodes = x[i].childNodes;
            if(xchildNodes.length<=1){
              alert("Has Child");
              var str1 = x[i].nodeName;
              var colonPos = str1.search(":");
              var stripedNodeName = str1.substr(colonPos+1);
              var counterValue = checkInHashTable(stripedNodeName);
              //alert("Striped Node Name: "+ stripedNodeName);
              console.log("Striped Node Name: " + stripedNodeName);
              newValue = "%%" + stripedNodeName +"_" + counterValue +"%%";
              //x[i].textContent = newValue;
              //txt += x[i].nodeName + ": " + newValue + "\n";
              if(xchildNodes.length == 0){
                x[i].textContent = newValue;
              /*  var newTxtNode = document.createTextNode(newValue);
                x[i].appendChild(newTxtNode);
                */
                alert("No Child");
              }
              else{
              x[i].firstChild.nodeValue = newValue;
              alert("Child Present");
              //txt += x[i].nodeName + ": " + newValue + "\n";
              //alert(txt);
              }
              console.log(txt);
            }
          }

        txt = xmlSer.serializeToString(RawXML);
        //alert("Hi2");
        console.log("Hi2");
        document.getElementById("UpdatedXMLTXTA").value = txt;
      }
      function checkInHashTable (elementName){
        var counter;
        if(hTable.hasOwnProperty(elementName)){
          hTable[elementName] = hTable[elementName] + 1;
          counter = hTable[elementName];
          //alert("Found in HashTable" + counter);
          console.log("Found in HashTable" + counter);
        }
        else{
          hTable[elementName] = 1;
          counter = hTable[elementName];
          //alert("Not Found in HashTable" + counter);
          console.log("Not Found in HashTable" + counter);
        }
        return counter;
      }

      function clearTxt(){
        document.getElementById("UpdatedXMLTXTA").value = '';
        document.getElementById("RawXMLTXTA").value = '';
      }

      function refresh()
      {
        window.location.href = sURL;
      }
    </script>
  </body>
</html>
